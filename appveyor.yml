image: Visual Studio 2017

clone_folder: c:\projects\flax

environment:
  global:
    DEPS_DBG_INCLUDES_DIR:  c:\projects\lib\mpir\DebugNoSyms\include;c:\projects\lib\mpfr\DebugNoSyms\include;c:\projects\lib\llvm\DebugNoSyms\include
    DEPS_REL_INCLUDES_DIR:  c:\projects\lib\mpir\Release\include;c:\projects\lib\mpfr\Release\include;c:\projects\lib\llvm\Release\include
    DEPS_DBG_LIBS_DIR:      c:\projects\lib\mpir\DebugNoSyms\lib;c:\projects\lib\mpfr\DebugNoSyms\lib;c:\projects\lib\llvm\DebugNoSyms\lib
    DEPS_REL_LIBS_DIR:      c:\projects\lib\mpir\Release\lib;c:\projects\lib\mpfr\Release\lib;c:\projects\lib\llvm\Release\lib

install:
  # Set up the build environment
  - cmd: call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x64
  # download our deps.
  - ps: "[Net.ServicePointManager]::SecurityProtocol = 'Ssl3, Tls, Tls11, Tls12'"
  - ps: Invoke-WebRequest 'https://github.com/flax-lang/flax/releases/download/win-build-deps/libraries.zip' -OutFile 'c:\projects\libs.zip'
  - ps: 7z x -y -oc:\projects\lib c:\projects\libs.zip


build_script:
  - ps: msbuild -verbosity:minimal -nologo -p:Configuration=Release c:\projects\flax\flax.vcxproj

test_script:
  - ps: cd c:\projects\flax
  - ps: Copy-Item -Recurse -Force libs\* build\sysroot\usr\local\lib\flaxlibs
  - ps: build\sysroot\windows\Release\flaxc.exe -sysroot build\sysroot -run build\tester.flx