language: cpp
compiler: clang

matrix:
  include:
  - os: linux
    dist: xenial
    sudo: false
  - os: osx
    osx_image: xcode11.2

cache:
  directories:
  - llvm

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - sourceline: deb https://apt.llvm.org/xenial/ llvm-toolchain-xenial-9 main
      key_url: https://apt.llvm.org/llvm-snapshot.gpg.key

    packages:
    - g++-9
    - llvm-9
    - llvm-9-dev
    - libllvm9
    - libmpfr-dev
    - libmpfr4

script:
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      if [ ! -d "llvm/9.0.0/bin" ]; then
        curl 'https://homebrew.bintray.com/bottles/llvm-9.0.0.high_sierra.bottle.tar.gz' -L -o llvm-9.0.0.tar.gz;
        tar -xf llvm-9.0.0.tar.gz;
      fi;
      echo "clang version:" $($CC --version);
      echo "clang path:" $(which $CC);
      PATH="$PATH:$(pwd)/llvm/9.0.0/bin" LLVM_CONFIG=llvm-config ENABLE_CODE_COVERAGE=yes make -j2 build;
    else
      CXX=g++-9 CC=gcc-9 LLVM_CONFIG=llvm-config-9 ENABLE_CODE_COVERAGE=yes make -j2 build;
    fi
  - LLVM_PROFILE_FILE="tester_llvm.profraw"    build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot --ffi-escape -profile -run -backend llvm build/tester.flx
  - LLVM_PROFILE_FILE="tester_interp.profraw"  build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot --ffi-escape -profile -run -backend interp build/tester.flx
  - LLVM_PROFILE_FILE="tester_compile.profraw" build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot --ffi-escape -profile build/tester.flx && ./tester
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      llvm/9.0.0/bin/llvm-profdata merge -sparse tester_llvm.profraw tester_interp.profraw tester_compile.profraw -o tester_all.profdata;
      llvm/9.0.0/bin/llvm-cov show ./build/sysroot/usr/local/bin/flaxc -instr-profile=tester_all.profdata > coverage.txt;
    else
      for filename in `find . -name '*.cpp'`; do gcov-9 -o "$filename".gcno $filename > /dev/null; done
    fi

notifications:
  email: false

after_success:
  - zip -r $TRAVIS_OS_NAME-x64 build/sysroot
  - bash <(curl -s https://codecov.io/bash)

deploy:
  provider: releases
  api-key: ${GITHUB_OAUTH_TOKEN}
  file: $TRAVIS_OS_NAME-x64.zip
  skip-cleanup: true
  on:
    all_branches: true
    tags: true


