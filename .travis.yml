language: cpp
compiler: clang

matrix:
    include:
    - os: linux
      dist: xenial
      sudo: false
    - os: osx
      osx_image: xcode11.2

cache:
    directories:
    - llvm@7

addons:
    apt:
        sources:
        - llvm-toolchain-xenial-7
        - ubuntu-toolchain-r-test

        packages:
        - g++-9
        - llvm-7
        - llvm-7-dev
        - libllvm7
        - libmpfr-dev
        - libmpfr4

script:
    - |
      if [ "$TRAVIS_OS_NAME" == "osx" ]; then
        if [ ! -d "llvm@7/7.1.0/bin" ]; then
          curl 'https://homebrew.bintray.com/bottles/llvm@7-7.1.0.high_sierra.bottle.tar.gz' -L -o llvm-7.1.0.tar.gz;
          tar -xf llvm-7.1.0.tar.gz;
        fi;
        echo "clang version:" $($CC --version);
        echo "clang path:" $(which $CC);
        PATH="$PATH:$(pwd)/llvm@7/7.1.0/bin" LLVM_CONFIG=llvm-config make -j2 build;
      else
        CXX=g++-9 CC=gcc-9 LLVM_CONFIG=llvm-config-7 make -j2 build;
      fi
    - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile -run -backend llvm build/tester.flx
    - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot --ffi-escape -profile -run -backend interp build/tester.flx
    - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile build/tester.flx && ./tester

notifications:
    email: false

after_success:
    - zip -r $TRAVIS_OS_NAME-x64 build/sysroot

deploy:
    provider: releases
    api-key: ${GITHUB_OAUTH_TOKEN}
    file: $TRAVIS_OS_NAME-x64.zip
    skip-cleanup: true
    on:
        all_branches: true
        tags: true
