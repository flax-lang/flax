name: CI
on: [push, pull_request]

jobs:
  build-linux:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
    - name: install dependencies
      run: |
        sudo echo "deb https://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main" | sudo tee -a /etc/apt/sources.list
        sudo wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo apt -y update
        sudo apt-get -o Dpkg::Options::="--force-overwrite" --allow-unauthenticated -y install -y gcc-8 llvm-9 llvm-9-dev libllvm9 libmpfr-dev libmpfr6
    - name: build
      env:
        LLVM_CONFIG: llvm-config-9
        CC: gcc-8
        CXX: g++-8
      run: make -j2 build
    - name: jit/llvm
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend llvm build/tester.flx
    - name: jit/interp
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend interp build/tester.flx
    - name: compile/llvm
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape build/tester.flx && ./tester
      
  build-macos:
    runs-on: macOS-10.14
    steps:
    - uses: actions/checkout@v1
    - name: cache llvm download
      id: cache-llvm
      uses: actions/cache@v1.0.0
      with:
        path: llvm
        key: ${{runner.os}}-llvm-9.0.0

    - name: download llvm
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      run: |
        curl 'https://homebrew.bintray.com/bottles/llvm-9.0.0.high_sierra.bottle.tar.gz' -L -o llvm-9.0.0.tar.gz
        tar -xf llvm-9.0.0.tar.gz
    - name: build
      env:
        LLVM_CONFIG: LLVM_CONFIG=llvm-config 
      run: PATH="$PATH:$(pwd)/llvm/9.0.0/bin" make -j2 build
    - name: jit/llvm
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend llvm build/tester.flx
    - name: jit/interp
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend interp build/tester.flx
    - name: compile/llvm
      run: build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape build/tester.flx && ./tester
      







