version: v1.0
name: flax
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "linux-build"
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
      jobs:
      - name: build
        commands:
          - checkout
          - sudo echo "deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main" | sudo tee -a /etc/apt/sources.list
          - sudo echo "deb-src http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main" | sudo tee -a /etc/apt/sources.list
          - sudo wget -O - http://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          - sudo apt -y update
          - sudo apt-get -o Dpkg::Options::="--force-overwrite" --allow-unauthenticated -y install -y llvm-9 llvm-9-dev libllvm9 libmpfr-dev libmpfr6
          - CXX=g++-8 CC=gcc-8 LLVM_CONFIG=llvm-config-9 make -j2 build
          - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend llvm build/tester.flx
          - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend interp build/tester.flx
          - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape build/tester.flx && ./tester
  - name: "macos-build"
     task:
       agent:
         machine:
           type: a1-standard-4
           os_image: macos-mojave-xcode10
       jobs:
       - name: build
         commands:
           - checkout
           - HOMEBREW_NO_INSTALL_CLEANUP=1 brew install llvm mpfr libffi
           - PATH="/usr/local/opt/llvm/bin:$PATH" LLVM_CONFIG=llvm-config make -j4 build
           - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend llvm build/tester.flx
           - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape -run -backend interp build/tester.flx
           - build/sysroot/usr/local/bin/flaxc -sysroot build/sysroot -profile --ffi-escape build/tester.flx && ./tester
